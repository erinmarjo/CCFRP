---
title: "Gopher RF Cross Correlation from Master II"
author: "Erin Johnston"
date: "12/9/2020"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)

```

```{r libraries}

library(tidyverse)
library(here)

```

# Gopher RF

```{r data}

full_cp_ml <- read_csv(here("Data/output", "2020-11-18_master_II.csv"))

gpr_full <- full_cp_ml %>%
  filter(species == "GPR")

MOCI <- read_csv(here("Data", "Central_California_MOCI.csv"))

```

# Age Subset

'Off central California, a few female gopher rockfish were mature at 20.7 cm (8.3 in.), while the largest immature female was 30.6 cm (12.2 in.) long.' (Love, 2002, pg. 142)

```{r age subset}

g_size_cutoff <- 20

juv_gpr <- gpr_full %>%
  filter(size <= g_size_cutoff)%>%
  group_by(drift, trip, area, site, month, day, year,
           gridcell, anglerhours) %>%
  summarise(cpue_sum = sum(cpue))%>%
  group_by(trip, area, site, month, day, year,
           gridcell) %>%
  summarise(cpue_date = mean(cpue_sum)) %>%
  group_by( area, site, year, gridcell) %>%
  summarise(cpue_cell = mean(cpue_date)) %>%
  group_by( area, site, year) %>%
  summarise(cpue_site = mean(cpue_cell))


adult_gpr <- gpr_full %>%
  filter(size > g_size_cutoff)%>%
  group_by(drift, trip, area, site, month, day, year,
           gridcell, anglerhours) %>%
  summarise(cpue_sum = sum(cpue)) %>%
  group_by(trip, area, site, month, day, year,
           gridcell) %>%
  summarise(cpue_date = mean(cpue_sum)) %>%
  group_by( area, site, year, gridcell) %>%
  summarise(cpue_cell = mean(cpue_date)) %>%
  group_by( area, site, year) %>%
  summarise(cpue_site = mean(cpue_cell))

full_gpr <- gpr_full %>%
  group_by(drift, trip, area, site, month, day, year,
           gridcell, anglerhours) %>%
  summarise(cpue_sum = sum(cpue))%>%
  group_by(trip, area, site, month, day, year,
           gridcell) %>%
  summarise(cpue_date = mean(cpue_sum)) %>%
  group_by( area, site, year, gridcell) %>%
  summarise(cpue_cell = mean(cpue_date)) %>%
  group_by( area, site, year) %>%
  summarise(cpue_site = mean(cpue_cell))

juv_moci_gpr <- left_join(juv_gpr, MOCI, by = "year")

adult_moci_gpr <- left_join(adult_gpr, MOCI, by = "year")

full_moci_gpr <- left_join(full_gpr, MOCI, by = "year")

```

## Cross correlation function loops

#### Protection status included

```{r loop general setup}

headers <- data.frame(area = character(), site = character(), 
                      season = character(), lag = character(), corr_values = character())

juv_g <- headers
adult_g <- headers
full_g <- headers

area_list <- c("PB", "BL", "AN", "PL")
site_list <- c("MPA", "REF")
season_list <- c("JFM", "AMJ", "JAS", "OND")


```

```{r loops}

## juv loop
for(j in area_list){
  for(k in site_list){
    for(l in season_list){
      juv_combos_g <- juv_moci_gpr %>%
      filter(area == j, site == k, season == l)
      cross_corr <- ccf(juv_combos_g$central_ca,
                        juv_combos_g$cpue_site, plot = F)
      lag <- cross_corr$lag
      corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      juv_g <- bind_rows(juv_g, c(area = j, site = k, season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
  }
}

## adult loop
for(j in area_list){
  for(k in site_list){
    for(l in season_list){
      adult_combos_g <- adult_moci_gpr %>%
      filter(area == j, site == k, season == l)
      cross_corr <- ccf(adult_combos_g$central_ca,
                        adult_combos_g$cpue_site, plot = F)
      lag <- cross_corr$lag
      corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      adult_g <- bind_rows(adult_g, c(area = j, site = k, season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
  }
}


## full loop
for(j in area_list){
  for(k in site_list){
    for(l in season_list){
      full_combos_g <- full_moci_gpr %>%
      filter(area == j, site == k, season == l)
      cross_corr <- ccf(full_combos_g$central_ca,
                        full_combos_g$cpue_site, plot = F)
      lag <- cross_corr$lag
      corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      full_g <- bind_rows(full_g, c(area = j, site = k, season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
  }
}

```

```{r plot set up}

## juv plot set up
vis_juv_g <- juv_g %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_juv_g$season <- factor(vis_juv_g$season, levels = c("JFM", "AMJ", "JAS", "OND"))

g_juv_moci_plot <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_juv_g, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Juvenile Gopher Rockfish Lag Correlation -MOCI", y = "correlation",
       caption = "Fig 1")+
  scale_x_continuous(limits=c(-8.5,0.5),breaks=seq(-8,0,1))+
  scale_y_continuous(limits = c(-0.6, 0.95), breaks = seq(-0.6, 0.9, 0.2), 
                     labels = c(-0.6, -0.4, -0.2, 0.0, 0.2, 0.4, 0.6, 0.8) )+
  theme_bw()+
  facet_grid(site ~ area)+
    theme(panel.grid=element_blank(),
          plot.caption = element_text(size = 8))

## adult plot set up
vis_adult_g <- adult_g %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_adult_g$season <- factor(vis_adult_g$season, levels = c("JFM", "AMJ", "JAS", "OND"))

g_adult_moci_plot <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_adult_g, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Adult Gopher Rockfish Lag Correlation -MOCI", y = "correlation",
       caption = "Fig 2")+
  scale_x_continuous(limits=c(-8.5,0.5),breaks=seq(-8,0,1))+
  scale_y_continuous(limits = c(-0.6, 0.9), breaks = seq(-0.6, 0.9, 0.2), 
                     labels = c(-0.6, -0.4, -0.2, 0.0, 0.2, 0.4, 0.6, 0.8) )+
  theme_bw()+
  facet_grid(site ~ area)+
    theme(panel.grid=element_blank(),
          plot.caption = element_text(size = 8))


## full plot set up
vis_full_g <- full_g %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_full_g$season <- factor(vis_full_g$season, levels = c("JFM", "AMJ", "JAS", "OND"))

g_full_moci_plot <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_full_g, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Gopher Rockfish Lag Correlation -MOCI", y = "correlation",
       caption = "Fig 3")+
  scale_x_continuous(limits=c(-8.5,0.5),breaks=seq(-8,0,1))+
  scale_y_continuous(limits = c(-0.6, 0.9), breaks = seq(-0.6, 0.9, 0.2), 
                     labels = c(-0.6, -0.4, -0.2, 0.0, 0.2, 0.4, 0.6, 0.8) )+
  theme_bw()+
  facet_grid(site ~ area)+
    theme(panel.grid=element_blank(),
          plot.caption = element_text(size = 8))

```


#### Figures MOCI with protection status

```{r fig1, fig.height= 6, fig.width= 10, fig.align= "center"}
g_juv_moci_plot
```


```{r fig2, fig.height= 6, fig.width= 10, fig.align= "center"}
g_adult_moci_plot
```


```{r fig3, fig.height= 6, fig.width= 10, fig.align= "center"}
g_full_moci_plot

```




#### Without Protection Status

```{r no site loop setup}

headers2 <- data.frame(area = character(), season = character(), 
                       lag = character(), corr_values = character())

juv_gns <- headers2
adult_gns <- headers2
full_gns <- headers2
```

```{r no site loops}

## juv no site loop
for(j in area_list){
  for(l in season_list){
    juv_combos_gns <- juv_moci_gpr %>%
      filter(area == j, season == l)
    cross_corr <- ccf(juv_combos_gns$central_ca,
                        juv_combos_gns$cpue_site, plot = F)
    lag <- cross_corr$lag
    corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      juv_gns <- bind_rows(juv_gns, c(area = j,  season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
}


## adult no site loop
for(j in area_list){
  for(l in season_list){
    adult_combos_gns <- adult_moci_gpr %>%
      filter(area == j, season == l)
    cross_corr <- ccf(adult_combos_gns$central_ca,
                        adult_combos_gns$cpue_site, plot = F)
    lag <- cross_corr$lag
    corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      adult_gns <- bind_rows(adult_gns, c(area = j,  season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
}


## together no site loop
for(j in area_list){
  for(l in season_list){
    full_combos_gns <- full_moci_gpr %>%
      filter(area == j, season == l)
    cross_corr <- ccf(full_combos_gns$central_ca,
                        full_combos_gns$cpue_site, plot = F)
    lag <- cross_corr$lag
    corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      full_gns <- bind_rows(full_gns, c(area = j,  season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
}


```


```{r no site plot setup}

## juv no site set up
vis_juv_gns <- juv_gns %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_juv_gns$season <- factor(vis_juv_gns$season, levels = c("JFM", "AMJ", "JAS", "OND"))

gns_juv_moci_plot <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_juv_gns, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Juvenile Gopher Rockfish Lag Correlation -MOCI", y = "correlation",
       caption = "Fig 4")+
  scale_x_continuous(limits=c(-10.5,0.5),breaks=seq(-10,0,1))+
  #scale_y_continuous(limits = c(-0.1, 0.1), breaks = seq(-0.1, 0.1, 0.1))+
  theme_bw()+
  facet_wrap(.~ area)+
    theme(panel.grid=element_blank())


## adult no site set up
vis_adult_gns <- adult_gns %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_adult_gns$season <- factor(vis_adult_gns$season, levels = c("JFM", "AMJ", "JAS", "OND"))

gns_adult_moci_plot <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999",  "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_adult_gns, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Adult Gopher Rockfish Lag Correlation -MOCI", y = "correlation",
       caption = "Fig 5")+
  scale_x_continuous(limits=c(-10.5,0.5),breaks=seq(-10,0,1))+
  #scale_y_continuous(limits = c(-0.2, 0.4), breaks = seq(-0.2, 0.4, 0.1))+
  theme_bw()+
  facet_wrap(.~ area) +
  theme(panel.grid=element_blank())


## full no site set up
vis_full_gns <- full_gns %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_full_gns$season <- factor(vis_full_gns$season, levels = c("JFM", "AMJ", "JAS", "OND"))

gns_full_moci_plot <-ggplot() +
  scale_color_manual(values = c( "#999999" ,  "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_full_gns, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Gopher Rockfish Lag Correlation -MOCI", y = "correlation",
       caption = "Fig 6")+
  scale_x_continuous(limits=c(-10.5,0.5),breaks=seq(-10,0,1))+
  #scale_y_continuous(limits = c(-0.2, 0.4), breaks = seq(-0.2, 0.4, 0.1))+
  theme_bw()+
  facet_wrap(.~ area)+
    theme(panel.grid=element_blank())



```


### Figures MOCI without protection status

```{r fig4, fig.height= 6, fig.width= 10, fig.align= "center"}

gns_juv_moci_plot

```


```{r fig5, fig.height= 6, fig.width= 10, fig.align= "center"}

gns_adult_moci_plot

```


```{r fig6, fig.height= 6, fig.width= 10, fig.align= "center"}

gns_full_moci_plot

```


# PDO

```{r pdo}

pdo <- read_csv(here("Data", "pdo_noaa_ncei.csv")) %>%
  transform( year = substr(date, 1,4), month = substr(date, 5, 6))%>%
  filter(year %in% c(2007:2019))%>%
  mutate(season = case_when(
    month %in% c("01", "02", "03") ~ "JFM",
    month %in% c("04", "05", "06") ~ "AMJ",
    month %in% c("07", "08", "09") ~ "JAS",
    month %in% c("10", "11", "12") ~ "OND")) %>%
  group_by(year, season) %>%
  summarise(pdo_val = mean(value)) %>%
  mutate(year = as.numeric(as.character(year)))

  
juv_pdo_gpr <- left_join(juv_gpr, pdo, by = "year")

adult_pdo_gpr <- left_join(adult_gpr, pdo, by = "year")

full_pdo_gpr <- left_join(full_gpr, pdo, by = "year")

```


## Cross correlation function loops

#### Protection status included

```{r PDO loop general setup}

headers <- data.frame(area = character(), site = character(), 
                      season = character(), lag = character(), corr_values = character())

juv_g_pdo <- headers
adult_g_pdo <- headers
full_g_pdo <- headers


```

```{r PDO loops}

## juv loop
for(j in area_list){
  for(k in site_list){
    for(l in season_list){
      juv_combos_g_pdo <- juv_pdo_gpr %>%
      filter(area == j, site == k, season == l)
      cross_corr <- ccf(juv_combos_g_pdo$pdo_val,
                        juv_combos_g_pdo$cpue_site, plot = F)
      lag <- cross_corr$lag
      corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      juv_g_pdo <- bind_rows(juv_g_pdo, c(area = j, site = k, season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
  }
}

## adult loop
for(j in area_list){
  for(k in site_list){
    for(l in season_list){
      adult_combos_g_pdo <- adult_pdo_gpr %>%
      filter(area == j, site == k, season == l)
      cross_corr <- ccf(adult_combos_g_pdo$pdo_val,
                        adult_combos_g_pdo$cpue_site, plot = F)
      lag <- cross_corr$lag
      corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      adult_g_pdo <- bind_rows(adult_g_pdo, c(area = j, site = k, season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
  }
}


## full loop
for(j in area_list){
  for(k in site_list){
    for(l in season_list){
      full_combos_g_pdo <- full_pdo_gpr %>%
      filter(area == j, site == k, season == l)
      cross_corr <- ccf(full_combos_g_pdo$pdo_val,
                        full_combos_g_pdo$cpue_site, plot = F)
      lag <- cross_corr$lag
      corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      full_g_pdo <- bind_rows(full_g_pdo, c(area = j, site = k, season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
  }
}

```

```{r PDO plot set up}

## juv plot set up
vis_juv_g_pdo <- juv_g_pdo %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_juv_g_pdo$season <- factor(vis_juv_g_pdo$season, levels = c("JFM", "AMJ", "JAS", "OND"))

g_juv_pdo_plot <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_juv_g_pdo, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Juvenile Gopher Rockfish Lag Correlation -PDO", y = "correlation",
       caption = "Fig 1")+
  scale_x_continuous(limits=c(-8.5,0.5),breaks=seq(-8,0,1))+
  scale_y_continuous(limits = c(-0.6, 0.95), breaks = seq(-0.6, 0.9, 0.2), 
                     labels = c(-0.6, -0.4, -0.2, 0.0, 0.2, 0.4, 0.6, 0.8) )+
  theme_bw()+
  facet_grid(site ~ area)+
    theme(panel.grid=element_blank(),
          plot.caption = element_text(size = 8))

## adult plot set up
vis_adult_g_pdo <- adult_g_pdo %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_adult_g_pdo$season <- factor(vis_adult_g_pdo$season, levels = c("JFM", "AMJ", "JAS", "OND"))

g_adult_pdo_plot <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_adult_g_pdo, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Adult Gopher Rockfish Lag Correlation -PDO", y = "correlation",
       caption = "Fig 2")+
  scale_x_continuous(limits=c(-8.5,0.5),breaks=seq(-8,0,1))+
  scale_y_continuous(limits = c(-0.6, 0.9), breaks = seq(-0.6, 0.9, 0.2), 
                     labels = c(-0.6, -0.4, -0.2, 0.0, 0.2, 0.4, 0.6, 0.8) )+
  theme_bw()+
  facet_grid(site ~ area)+
    theme(panel.grid=element_blank(),
          plot.caption = element_text(size = 8))


## full plot set up
vis_full_g_pdo <- full_g_pdo %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_full_g_pdo$season <- factor(vis_full_g_pdo$season, levels = c("JFM", "AMJ", "JAS", "OND"))

g_full_pdo_plot <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_full_g_pdo, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Gopher Rockfish Lag Correlation -PDO", y = "correlation",
       caption = "Fig 3")+
  scale_x_continuous(limits=c(-8.5,0.5),breaks=seq(-8,0,1))+
  scale_y_continuous(limits = c(-0.6, 0.9), breaks = seq(-0.6, 0.9, 0.2), 
                     labels = c(-0.6, -0.4, -0.2, 0.0, 0.2, 0.4, 0.6, 0.8) )+
  theme_bw()+
  facet_grid(site ~ area)+
    theme(panel.grid=element_blank(),
          plot.caption = element_text(size = 8))

```


#### Figures PDO with protection status

```{r fig7, fig.height= 6, fig.width= 10, fig.align= "center"}

g_juv_pdo_plot

```


```{r fig8, fig.height= 6, fig.width= 10, fig.align= "center"}

g_adult_pdo_plot

```


```{r fig9, fig.height= 6, fig.width= 10, fig.align= "center"}

g_full_pdo_plot

```




#### Without Protection Status

```{r PDO no site loop setup}

headers2 <- data.frame(area = character(), season = character(), 
                       lag = character(), corr_values = character())

juv_gns_pdo <- headers2
adult_gns_pdo <- headers2
full_gns_pdo <- headers2
```

```{r PDO no site loops}

## juv no site loop
for(j in area_list){
  for(l in season_list){
    juv_combos_gns_pdo <- juv_pdo_gpr %>%
      filter(area == j, season == l)
    cross_corr <- ccf(juv_combos_gns_pdo$pdo_val,
                      juv_combos_gns_pdo$cpue_site, plot = F)
    lag <- cross_corr$lag
    corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      juv_gns_pdo <- bind_rows(juv_gns_pdo, c(area = j,  season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
}


## adult no site loop
for(j in area_list){
  for(l in season_list){
    adult_combos_gns_pdo <- adult_pdo_gpr %>%
      filter(area == j, season == l)
    cross_corr <- ccf(adult_combos_gns_pdo$pdo_val,
                      adult_combos_gns_pdo$cpue_site, plot = F)
    lag <- cross_corr$lag
    corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      adult_gns_pdo <- bind_rows(adult_gns_pdo, c(area = j,  season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
}


## together no site loop
for(j in area_list){
  for(l in season_list){
    full_combos_gns_pdo <- full_pdo_gpr %>%
      filter(area == j, season == l)
    cross_corr <- ccf(full_combos_gns_pdo$pdo_val,
                      full_combos_gns_pdo$cpue_site, plot = F)
    lag <- cross_corr$lag
    corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      full_gns_pdo <- bind_rows(full_gns_pdo, c(area = j,  season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
}


```


```{r PDO no site plot setup}

## juv no site set up
vis_juv_gns_pdo <- juv_gns_pdo %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_juv_gns_pdo$season <- factor(vis_juv_gns_pdo$season, levels = c("JFM", "AMJ", "JAS", "OND"))

gns_juv_pdo_plot <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_juv_gns_pdo, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Juvenile Gopher Rockfish Lag Correlation -PDO", y = "correlation",
       caption = "Fig 4")+
  scale_x_continuous(limits=c(-10.5,0.5),breaks=seq(-10,0,1))+
  #scale_y_continuous(limits = c(-0.1, 0.1), breaks = seq(-0.1, 0.1, 0.1))+
  theme_bw()+
  facet_wrap(.~ area)+
    theme(panel.grid=element_blank())


## adult no site set up
vis_adult_gns_pdo <- adult_gns_pdo %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_adult_gns_pdo$season <- factor(vis_adult_gns_pdo$season, levels = c("JFM", "AMJ", "JAS", "OND"))

gns_adult_pdo_plot <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999",  "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_adult_gns_pdo, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Adult Gopher Rockfish Lag Correlation -PDO", y = "correlation",
       caption = "Fig 5")+
  scale_x_continuous(limits=c(-10.5,0.5),breaks=seq(-10,0,1))+
  #scale_y_continuous(limits = c(-0.2, 0.4), breaks = seq(-0.2, 0.4, 0.1))+
  theme_bw()+
  facet_wrap(.~ area) +
  theme(panel.grid=element_blank())


## full no site set up
vis_full_gns_pdo <- full_gns_pdo %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_full_gns_pdo$season <- factor(vis_full_gns_pdo$season, levels = c("JFM", "AMJ", "JAS", "OND"))

gns_full_pdo_plot <-ggplot() +
  scale_color_manual(values = c( "#999999" ,  "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_full_gns_pdo, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Gopher Rockfish Lag Correlation -PDO", y = "correlation",
       caption = "Fig 6")+
  scale_x_continuous(limits=c(-10.5,0.5),breaks=seq(-10,0,1))+
  #scale_y_continuous(limits = c(-0.2, 0.4), breaks = seq(-0.2, 0.4, 0.1))+
  theme_bw()+
  facet_wrap(.~ area)+
    theme(panel.grid=element_blank())



```


### Figures PDO without protection status

```{r fig10, fig.height= 6, fig.width= 10, fig.align= "center"}

gns_juv_pdo_plot

```


```{r fig11, fig.height= 6, fig.width= 10, fig.align= "center"}

gns_adult_pdo_plot

```


```{r fig12, fig.height= 6, fig.width= 10, fig.align= "center"}

gns_full_pdo_plot

```









# EXTRA EXTRA
#### Black Rockfish

```{r}
#ggsave("2020-11-18_juv_moci_lag.png", plot = juv_moci_plot, path = "C:/Users/erinj/Documents/Thesis/Figures/Lag", dpi = 1000, width = 8, height = 4)
#ggsave("2020-11-18_adult_moci_lag.png", plot = adult_moci_plot, path = "C:/Users/erinj/Documents/Thesis/Figures/Lag", dpi = 1000, width = 8, height = 4)
#ggsave("2020-11-18_full_moci_lag.png", plot = full_moci_plot, path = "C:/Users/erinj/Documents/Thesis/Figures/Lag", dpi = 1000, width = 8, height = 4)

## Grant 20202-11-18
## break down MOCI - component parts.
## include strongest lag in model
## use as exploration. Are there lags to consider. 
## explore, come up with Q's
## Is the a biological lag time in the response of cpue to moci?
## are the component parts of moci driving an overall pattern?
## are there differential spatial responses to oceanographic parameters
## is there a differential response between juveniles and adult rockfish?

```


```{r black subset, eval = F, echo=F}

bla_full <- full_cp_ml %>%
  filter(species == "BLA")


full_bla <- bla_full %>%
  group_by(drift, trip, area, site, month, day, year,
           gridcell, anglerhours) %>%
  summarise(cpue_sum = sum(cpue))%>%
  group_by(trip, area, site, month, day, year,
           gridcell) %>%
  summarise(cpue_date = mean(cpue_sum)) %>%
  group_by( area, site, year, gridcell) %>%
  summarise(cpue_cell = mean(cpue_date)) %>%
  group_by( area, site, year) %>%
  summarise(cpue_site = mean(cpue_cell))


full_moci_bla <- left_join(full_bla, MOCI, by = "year")

headers_1_bla <- headers_2 %>%
  select(-site)


full_bl <- headers_1_bla


for(j in area_list){
  for(l in season_list){
    full_combos_bl <- full_moci_bla %>%
      filter(area == j, season == l)
    cross_corr <- ccf(full_combos_bl$central_ca,
                        full_combos_bl$cpue_site, plot = F)
    lag <- cross_corr$lag
    corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      full_bl <- bind_rows(full_bl, c(area = j,  season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
}

full_bl <- full_bl %>%
  arrange(desc(corr_values))


vis_full_bl <- full_bl %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))


vis_full_bl$season <- factor(vis_full_bl$season, levels = c("JFM", "AMJ", "JAS", "OND"))



full_bl_moci_plot <-ggplot() +
  scale_color_manual(values = c( "#999999" ,  "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_full_bl, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Black Rockfish Lag Correlation -MOCI", y = "correlation")+
  scale_x_continuous(limits=c(-10.5,0.5),breaks=seq(-10,0,1))+
  #scale_y_continuous(limits = c(-0.2, 0.4), breaks = seq(-0.2, 0.4, 0.1))+
  theme_bw()+
  facet_wrap(.~ area)+
    theme(panel.grid=element_blank())


full_bl_moci_plot

```