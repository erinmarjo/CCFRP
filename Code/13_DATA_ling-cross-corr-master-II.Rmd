---
title: "Lingcod Cross Correlation from Master II"
author: "Erin Johnston"
date: "12/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
```

```{r libraries}

library(tidyverse)
library(here)
library(patchwork)

```

# Lingcod

```{r data}

full_cp_ml <- read_csv(here("Data/output", "2020-11-18_master_II.csv"))

lcd_full <- full_cp_ml %>%
  filter(species == "LCD")

MOCI <- read_csv(here("Data", "Central_California_MOCI.csv"))

```

# Age Subset

'Silberberg et al. (2001) found that for Northern and Central California, a few females were mature at 43.7 cm (17 in, FL, 2 years), 50% at 55.7 cm (22 in, 4 years), and 100% at 75 cm (30 in, 9 years). For males, these values were 30 cm (12 in, 2 years), 46.1 cm (18 in, 3 years), and 69 cm (27 in, 8 years) respectively.' (Love, 2011. pg 297)

```{r}
## later: query the ratio of M:F lings in the dataset
size_cutoff <- 37

juv_lcd <- lcd_full %>%
  filter(size <= size_cutoff)%>%
  group_by(drift, trip, area, site, month, day, year,
           gridcell, anglerhours) %>%
  summarise(cpue_sum = sum(cpue))%>%
  group_by(trip, area, site, month, day, year,
           gridcell) %>%
  summarise(cpue_date = mean(cpue_sum)) %>%
  group_by( area, site, year, gridcell) %>%
  summarise(cpue_cell = mean(cpue_date)) %>%
  group_by( area, site, year) %>%
  summarise(cpue_site = mean(cpue_cell))


adult_lcd <- lcd_full %>%
  filter(size > size_cutoff)%>%
  group_by(drift, trip, area, site, month, day, year,
           gridcell, anglerhours) %>%
  summarise(cpue_sum = sum(cpue)) %>%
  group_by(trip, area, site, month, day, year,
           gridcell) %>%
  summarise(cpue_date = mean(cpue_sum)) %>%
  group_by( area, site, year, gridcell) %>%
  summarise(cpue_cell = mean(cpue_date)) %>%
  group_by( area, site, year) %>%
  summarise(cpue_site = mean(cpue_cell))

full_lcd <- lcd_full %>%
  group_by(drift, trip, area, site, month, day, year,
           gridcell, anglerhours) %>%
  summarise(cpue_sum = sum(cpue))%>%
  group_by(trip, area, site, month, day, year,
           gridcell) %>%
  summarise(cpue_date = mean(cpue_sum)) %>%
  group_by( area, site, year, gridcell) %>%
  summarise(cpue_cell = mean(cpue_date)) %>%
  group_by( area, site, year) %>%
  summarise(cpue_site = mean(cpue_cell))

juv_moci_lcd <- left_join(juv_lcd, MOCI, by = "year")

adult_moci_lcd <- left_join(adult_lcd, MOCI, by = "year")

full_moci_lcd <- left_join(full_lcd, MOCI, by = "year")

```


## Cross correlation function loops

#### Protection status included

```{r loop general setup}

headers <- data.frame(area = character(), site = character(), 
                      season = character(), lag = character(), corr_values = character())

juv_l <- headers
adult_l <- headers
full_l <- headers

area_list <- c("PB", "BL", "AN", "PL")
site_list <- c("MPA", "REF")
season_list <- c("JFM", "AMJ", "JAS", "OND")


```


```{r loops}

## juv loop
for(j in area_list){
  for(k in site_list){
    for(l in season_list){
      juv_combos_l <- juv_moci_lcd%>%
      filter(area == j, site == k, season == l)
      cross_corr <- ccf(juv_combos_l$central_ca,
                        juv_combos_l$cpue_site, plot = F)
      lag <- cross_corr$lag
      corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      juv_l <- bind_rows(juv_l, c(area = j, site = k, season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
  }
}

## adult loop
for(j in area_list){
  for(k in site_list){
    for(l in season_list){
      adult_combos_l <- adult_moci_lcd %>%
      filter(area == j, site == k, season == l)
      cross_corr <- ccf(adult_combos_l$central_ca,
                        adult_combos_l$cpue_site, plot = F)
      lag <- cross_corr$lag
      corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      adult_l <- bind_rows(adult_l, c(area = j, site = k, season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
  }
}


## full loop
for(j in area_list){
  for(k in site_list){
    for(l in season_list){
      full_combos_l <- full_moci_lcd %>%
      filter(area == j, site == k, season == l)
      cross_corr <- ccf(full_combos_l$central_ca,
                        full_combos_l$cpue_site, plot = F)
      lag <- cross_corr$lag
      corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      full_l <- bind_rows(full_l, c(area = j, site = k, season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
  }
}

```

```{r plot set up}

## juv plot set up
vis_juv_l <- juv_l %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_juv_l$season <- factor(vis_juv_l$season, levels = c("JFM", "AMJ", "JAS", "OND"))

l_juv_moci_plot <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_juv_l, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Juvenile Lingcod Lag Correlation -MOCI", y = "correlation",
       caption = "Fig 1")+
  scale_x_continuous(limits=c(-8.5,0.5),breaks=seq(-8,0,1))+
  scale_y_continuous(limits = c(-0.6, 0.95), breaks = seq(-0.6, 0.9, 0.2), 
                     labels = c(-0.6, -0.4, -0.2, 0.0, 0.2, 0.4, 0.6, 0.8) )+
  theme_bw()+
  facet_grid(site ~ area)+
    theme(panel.grid=element_blank(),
          plot.caption = element_text(size = 8))

## adult plot set up
vis_adult_l <- adult_l %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_adult_l$season <- factor(vis_adult_l$season, levels = c("JFM", "AMJ", "JAS", "OND"))

l_adult_moci_plot <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_adult_l, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Adult Lingcod Lag Correlation -MOCI", y = "correlation",
       caption = "Fig 2")+
  scale_x_continuous(limits=c(-8.5,0.5),breaks=seq(-8,0,1))+
  scale_y_continuous(limits = c(-0.6, 0.9), breaks = seq(-0.6, 0.9, 0.2), 
                     labels = c(-0.6, -0.4, -0.2, 0.0, 0.2, 0.4, 0.6, 0.8) )+
  theme_bw()+
  facet_grid(site ~ area)+
    theme(panel.grid=element_blank(),
          plot.caption = element_text(size = 8))


## full plot set up
vis_full_l <- full_l %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_full_l$season <- factor(vis_full_l$season, levels = c("JFM", "AMJ", "JAS", "OND"))

l_full_moci_plot <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_full_l, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Lingcod Lag Correlation -MOCI", y = "correlation",
       caption = "Fig 3")+
  scale_x_continuous(limits=c(-8.5,0.5),breaks=seq(-8,0,1))+
  scale_y_continuous(limits = c(-0.6, 0.9), breaks = seq(-0.6, 0.9, 0.2), 
                     labels = c(-0.6, -0.4, -0.2, 0.0, 0.2, 0.4, 0.6, 0.8) )+
  theme_bw()+
  facet_grid(site ~ area)+
    theme(panel.grid=element_blank(),
          plot.caption = element_text(size = 8))

```


```{r fig1, fig.height= 6, fig.width= 10, fig.align= "center"}
l_juv_moci_plot
```


```{r fig2, fig.height= 6, fig.width= 10, fig.align= "center"}
l_adult_moci_plot
```


```{r fig3, fig.height= 6, fig.width= 10, fig.align= "center"}
l_full_moci_plot

```

```{r figextra, fig.height= 6, fig.width= 10, fig.align= "center"}

l_juv_moci_plot2 <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_juv_l, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Juvenile Lingcod Lag Correlation -MOCI", y = "correlation",
       caption = "Fig 1")+
  scale_x_continuous(limits=c(-8.5,0.5),breaks=seq(-8,0,1))+
  scale_y_continuous(limits = c(-0.6, 0.95), breaks = seq(-0.6, 0.9, 0.2), 
                     labels = c(-0.6, -0.4, -0.2, 0.0, 0.2, 0.4, 0.6, 0.8) )+
  theme_bw()+
  facet_grid(site ~ area)+
    theme(panel.grid=element_blank(),
          plot.caption = element_text(size = 8),
          legend.position = "none")

l_adult_moci_plot2 <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_adult_l, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Adult Lingcod Lag Correlation -MOCI", y = "",
       caption = "Fig 2")+
  scale_x_continuous(limits=c(-8.5,0.5),breaks=seq(-8,0,1))+
  scale_y_continuous(limits = c(-0.6, 0.9), breaks = seq(-0.6, 0.9, 0.2), 
                     labels = c(-0.6, -0.4, -0.2, 0.0, 0.2, 0.4, 0.6, 0.8) )+
  theme_bw()+
  facet_grid(site ~ area)+
    theme(panel.grid=element_blank(),
          plot.caption = element_text(size = 8))

l_juv_moci_plot2 + l_adult_moci_plot2

```

# Without Protection Status

```{r}

headers2 <- data.frame(area = character(), season = character(), 
                       lag = character(), corr_values = character())

juv_lns <- headers2
adult_lns <- headers2
full_lns <- headers2


```



```{r no site loops}

## juv no site loop
for(j in area_list){
  for(l in season_list){
    juv_combos_lns <- juv_moci_lcd %>%
      filter(area == j, season == l)
    cross_corr <- ccf(juv_combos_lns$central_ca,
                        juv_combos_lns$cpue_site, plot = F)
    lag <- cross_corr$lag
    corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      juv_lns <- bind_rows(juv_lns, c(area = j,  season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
}


## adult no site loop
for(j in area_list){
  for(l in season_list){
    adult_combos_lns <- adult_moci_lcd %>%
      filter(area == j, season == l)
    cross_corr <- ccf(adult_combos_lns$central_ca,
                        adult_combos_lns$cpue_site, plot = F)
    lag <- cross_corr$lag
    corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      adult_lns <- bind_rows(adult_lns, c(area = j,  season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
}


## together no site loop
for(j in area_list){
  for(l in season_list){
    full_combos_lns <- full_moci_lcd %>%
      filter(area == j, season == l)
    cross_corr <- ccf(full_combos_lns$central_ca,
                        full_combos_lns$cpue_site, plot = F)
    lag <- cross_corr$lag
    corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      full_lns <- bind_rows(full_lns, c(area = j,  season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
}


```


```{r}

## juv no site set up
vis_juv_lns <- juv_lns %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_juv_lns$season <- factor(vis_juv_lns$season, levels = c("JFM", "AMJ", "JAS", "OND"))

lns_juv_moci_plot <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_juv_lns, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Juvenile Lingcod Lag Correlation -MOCI", y = "correlation",
       caption = "Fig 4")+
  scale_x_continuous(limits=c(-10.5,0.5),breaks=seq(-10,0,1))+
  #scale_y_continuous(limits = c(-0.1, 0.1), breaks = seq(-0.1, 0.1, 0.1))+
  theme_bw()+
  facet_wrap(.~ area)+
    theme(panel.grid=element_blank())


## adult no site set up
vis_adult_lns <- adult_lns %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_adult_lns$season <- factor(vis_adult_lns$season, levels = c("JFM", "AMJ", "JAS", "OND"))

lns_adult_moci_plot <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999",  "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_adult_lns, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Adult Lingcod Lag Correlation -MOCI", y = "correlation",
       caption = "Fig 5")+
  scale_x_continuous(limits=c(-10.5,0.5),breaks=seq(-10,0,1))+
  #scale_y_continuous(limits = c(-0.2, 0.4), breaks = seq(-0.2, 0.4, 0.1))+
  theme_bw()+
  facet_wrap(.~ area) +
  theme(panel.grid=element_blank())


## full no site set up
vis_full_lns <- full_lns %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_full_lns$season <- factor(vis_full_lns$season, levels = c("JFM", "AMJ", "JAS", "OND"))

lns_full_moci_plot <-ggplot() +
  scale_color_manual(values = c( "#999999" ,  "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_full_lns, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Lingcod Lag Correlation -MOCI", y = "correlation",
       caption = "Fig 6")+
  scale_x_continuous(limits=c(-10.5,0.5),breaks=seq(-10,0,1))+
  #scale_y_continuous(limits = c(-0.2, 0.4), breaks = seq(-0.2, 0.4, 0.1))+
  theme_bw()+
  facet_wrap(.~ area)+
    theme(panel.grid=element_blank())



```




```{r fig4, fig.height= 6, fig.width= 10, fig.align= "center"}

lns_juv_moci_plot

```


```{r fig5, fig.height= 6, fig.width= 10, fig.align= "center"}

lns_adult_moci_plot

```


```{r fig6, fig.height= 6, fig.width= 10, fig.align= "center"}

lns_full_moci_plot

```


# PDO

```{r pdo}

pdo <- read_csv(here("Data", "pdo_noaa_ncei.csv")) %>%
  transform( year = substr(date, 1,4), month = substr(date, 5, 6))%>%
  filter(year %in% c(2007:2019))%>%
  mutate(season = case_when(
    month %in% c("01", "02", "03") ~ "JFM",
    month %in% c("04", "05", "06") ~ "AMJ",
    month %in% c("07", "08", "09") ~ "JAS",
    month %in% c("10", "11", "12") ~ "OND")) %>%
  group_by(year, season) %>%
  summarise(pdo_val = mean(value)) %>%
  mutate(year = as.numeric(as.character(year)))

  
juv_pdo_lcd <- left_join(juv_lcd, pdo, by = "year")

adult_pdo_lcd <- left_join(adult_lcd, pdo, by = "year")

full_pdo_lcd <- left_join(full_lcd, pdo, by = "year")

```


## Cross correlation function loops

#### Protection status included

```{r PDO loop general setup}

headers <- data.frame(area = character(), site = character(), 
                      season = character(), lag = character(), corr_values = character())

juv_l_pdo <- headers
adult_l_pdo <- headers
full_l_pdo <- headers


```

```{r PDO loops}

## juv loop
for(j in area_list){
  for(k in site_list){
    for(l in season_list){
      juv_combos_l_pdo <- juv_pdo_lcd %>%
      filter(area == j, site == k, season == l)
      cross_corr <- ccf(juv_combos_l_pdo$pdo_val,
                        juv_combos_l_pdo$cpue_site, plot = F)
      lag <- cross_corr$lag
      corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      juv_l_pdo <- bind_rows(juv_l_pdo, c(area = j, site = k, season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
  }
}

## adult loop
for(j in area_list){
  for(k in site_list){
    for(l in season_list){
      adult_combos_l_pdo <- adult_pdo_lcd %>%
      filter(area == j, site == k, season == l)
      cross_corr <- ccf(adult_combos_l_pdo$pdo_val,
                        adult_combos_l_pdo$cpue_site, plot = F)
      lag <- cross_corr$lag
      corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      adult_l_pdo <- bind_rows(adult_l_pdo, c(area = j, site = k, season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
  }
}


## full loop
for(j in area_list){
  for(k in site_list){
    for(l in season_list){
      full_combos_l_pdo <- full_pdo_lcd %>%
      filter(area == j, site == k, season == l)
      cross_corr <- ccf(full_combos_l_pdo$pdo_val,
                        full_combos_l_pdo$cpue_site, plot = F)
      lag <- cross_corr$lag
      corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      full_l_pdo <- bind_rows(full_l_pdo, c(area = j, site = k, season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
  }
}

```

```{r PDO plot set up}

## juv plot set up
vis_juv_l_pdo <- juv_l_pdo %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_juv_l_pdo$season <- factor(vis_juv_l_pdo$season, levels = c("JFM", "AMJ", "JAS", "OND"))

l_juv_pdo_plot <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_juv_l_pdo, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Juvenile Lingcod Lag Correlation -PDO", y = "correlation",
       caption = "Fig 1")+
  scale_x_continuous(limits=c(-8.5,0.5),breaks=seq(-8,0,1))+
  scale_y_continuous(limits = c(-0.8, 0.95), breaks = seq(-0.8, 0.9, 0.2), 
                     labels = c(-0.8, -0.6, -0.4, -0.2, 0.0, 0.2, 0.4, 0.6, 0.8) )+
  theme_bw()+
  facet_grid(site ~ area)+
    theme(panel.grid=element_blank(),
          plot.caption = element_text(size = 8))

## adult plot set up
vis_adult_l_pdo <- adult_l_pdo %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_adult_l_pdo$season <- factor(vis_adult_l_pdo$season, levels = c("JFM", "AMJ", "JAS", "OND"))

l_adult_pdo_plot <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_adult_l_pdo, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Adult Lingcod Lag Correlation -PDO", y = "correlation",
       caption = "Fig 2")+
  scale_x_continuous(limits=c(-8.5,0.5),breaks=seq(-8,0,1))+
  scale_y_continuous(limits = c(-0.8, 0.9), breaks = seq(-0.8, 0.9, 0.2), 
                     labels = c(-0.8, -0.6, -0.4, -0.2, 0.0, 0.2, 0.4, 0.6, 0.8) )+
  theme_bw()+
  facet_grid(site ~ area)+
    theme(panel.grid=element_blank(),
          plot.caption = element_text(size = 8))


## full plot set up
vis_full_l_pdo <- full_l_pdo %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_full_l_pdo$season <- factor(vis_full_l_pdo$season, levels = c("JFM", "AMJ", "JAS", "OND"))

l_full_pdo_plot <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_full_l_pdo, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Lingcod Lag Correlation -PDO", y = "correlation",
       caption = "Fig 3")+
  scale_x_continuous(limits=c(-8.5,0.5),breaks=seq(-8,0,1))+
  scale_y_continuous(limits = c(-0.8, 0.9), breaks = seq(-0.8, 0.9, 0.2), 
                     labels = c(-0.8, -0.6, -0.4, -0.2, 0.0, 0.2, 0.4, 0.6, 0.8) )+
  theme_bw()+
  facet_grid(site ~ area)+
    theme(panel.grid=element_blank(),
          plot.caption = element_text(size = 8))

```


#### Figures PDO with protection status

```{r fig7, fig.height= 6, fig.width= 10, fig.align= "center"}

l_juv_pdo_plot

```


```{r fig8, fig.height= 6, fig.width= 10, fig.align= "center"}

l_adult_pdo_plot

```


```{r fig9, fig.height= 6, fig.width= 10, fig.align= "center"}

l_full_pdo_plot

```




#### Without Protection Status

```{r PDO no site loop setup}

headers2 <- data.frame(area = character(), season = character(), 
                       lag = character(), corr_values = character())

juv_lns_pdo <- headers2
adult_lns_pdo <- headers2
full_lns_pdo <- headers2
```

```{r PDO no site loops}

## juv no site loop
for(j in area_list){
  for(l in season_list){
    juv_combos_lns_pdo <- juv_pdo_lcd %>%
      filter(area == j, season == l)
    cross_corr <- ccf(juv_combos_lns_pdo$pdo_val,
                      juv_combos_lns_pdo$cpue_site, plot = F)
    lag <- cross_corr$lag
    corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      juv_lns_pdo <- bind_rows(juv_lns_pdo, c(area = j,  season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
}


## adult no site loop
for(j in area_list){
  for(l in season_list){
    adult_combos_lns_pdo <- adult_pdo_lcd %>%
      filter(area == j, season == l)
    cross_corr <- ccf(adult_combos_lns_pdo$pdo_val,
                      adult_combos_lns_pdo$cpue_site, plot = F)
    lag <- cross_corr$lag
    corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      adult_lns_pdo <- bind_rows(adult_lns_pdo, c(area = j,  season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
}


## together no site loop
for(j in area_list){
  for(l in season_list){
    full_combos_lns_pdo <- full_pdo_lcd %>%
      filter(area == j, season == l)
    cross_corr <- ccf(full_combos_lns_pdo$pdo_val,
                      full_combos_lns_pdo$cpue_site, plot = F)
    lag <- cross_corr$lag
    corr_values <- cross_corr$acf
      for(m in 1:length(lag)){
      full_lns_pdo <- bind_rows(full_lns_pdo, c(area = j,  season = l, 
                                     lag = lag[m], corr_values = corr_values[m]))
      }

    }
}


```


```{r PDO no site plot setup}

## juv no site set up
vis_juv_lns_pdo <- juv_lns_pdo %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_juv_lns_pdo$season <- factor(vis_juv_lns_pdo$season, levels = c("JFM", "AMJ", "JAS", "OND"))

lns_juv_pdo_plot <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_juv_lns_pdo, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Juvenile Lingcod Lag Correlation -PDO", y = "correlation",
       caption = "Fig 4")+
  scale_x_continuous(limits=c(-10.5,0.5),breaks=seq(-10,0,1))+
  #scale_y_continuous(limits = c(-0.1, 0.1), breaks = seq(-0.1, 0.1, 0.1))+
  theme_bw()+
  facet_wrap(.~ area)+
    theme(panel.grid=element_blank())


## adult no site set up
vis_adult_lns_pdo <- adult_lns_pdo %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_adult_lns_pdo$season <- factor(vis_adult_lns_pdo$season, levels = c("JFM", "AMJ", "JAS", "OND"))

lns_adult_pdo_plot <- ggplot() +
  scale_color_manual(values = c(  "#999999" , "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999",  "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_adult_lns_pdo, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Adult Lingcod Lag Correlation -PDO", y = "correlation",
       caption = "Fig 5")+
  scale_x_continuous(limits=c(-10.5,0.5),breaks=seq(-10,0,1))+
  #scale_y_continuous(limits = c(-0.2, 0.4), breaks = seq(-0.2, 0.4, 0.1))+
  theme_bw()+
  facet_wrap(.~ area) +
  theme(panel.grid=element_blank())


## full no site set up
vis_full_lns_pdo <- full_lns_pdo %>%
  filter(lag %in% c(-10:0))%>%
  mutate(corr_values = as.numeric(corr_values),
         lag = as.numeric(lag))

vis_full_lns_pdo$season <- factor(vis_full_lns_pdo$season, levels = c("JFM", "AMJ", "JAS", "OND"))

lns_full_pdo_plot <-ggplot() +
  scale_color_manual(values = c( "#999999" ,  "#009999", "#666666", "#000000"))+
  scale_fill_manual(values = c( "#999999", "#009999", "#666666", "#000000"))+
  geom_col(position = "dodge2", data = vis_full_lns_pdo, aes(lag, y = corr_values,  color = season,
                                               fill = season))+
  labs(title = "Lingcod Lag Correlation -PDO", y = "correlation",
       caption = "Fig 6")+
  scale_x_continuous(limits=c(-10.5,0.5),breaks=seq(-10,0,1))+
  #scale_y_continuous(limits = c(-0.2, 0.4), breaks = seq(-0.2, 0.4, 0.1))+
  theme_bw()+
  facet_wrap(.~ area)+
    theme(panel.grid=element_blank())



```


### Figures PDO without protection status

```{r fig10, fig.height= 6, fig.width= 10, fig.align= "center"}

lns_juv_pdo_plot

```


```{r fig11, fig.height= 6, fig.width= 10, fig.align= "center"}

lns_adult_pdo_plot

```


```{r fig12, fig.height= 6, fig.width= 10, fig.align= "center"}

lns_full_pdo_plot

```